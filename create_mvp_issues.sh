#!/bin/bash
# Script to create MVP launch issues in arkavo-org/arkavo-edge
# Usage: GITHUB_TOKEN=your_token ./create_mvp_issues.sh

set -e

if [ -z "$GITHUB_TOKEN" ]; then
    echo "Error: GITHUB_TOKEN environment variable is required"
    echo "Usage: GITHUB_TOKEN=ghp_xxxx ./create_mvp_issues.sh"
    echo ""
    echo "Create a token at: https://github.com/settings/tokens/new"
    echo "Required scopes: repo (full control of private repositories)"
    exit 1
fi

REPO="arkavo-org/arkavo-edge"
API_URL="https://api.github.com/repos/$REPO/issues"

echo "Creating MVP Launch issues in $REPO..."
echo ""

# Issue 1: Pricing Page
echo "Creating Issue 1: Pricing Page & Commercial Tier Structure..."
ISSUE1=$(curl -s -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  -H "Content-Type: application/json" \
  -d '{
  "title": "Create Pricing Page & Commercial Tier Structure",
  "body": "## Priority: CRITICAL - BLOCKING MONETIZATION\n\n**Related to:** MVP Launch Milestone\n**Effort:** 2-3 days\n\n## Objective\nCreate a clear pricing structure and documentation to enable monetization of arkavo-edge.\n\n## Requirements\n\n### Pricing Tiers\n\n**FREE TIER - \"Developer\"**\n- 100 agent tasks/month\n- Single user\n- Community support (GitHub issues)\n- All core features\n- Purpose: Land & expand, developer adoption\n\n**PRO TIER - $49/month per user**\n- 5,000 agent tasks/month\n- Up to 5 users\n- Email support (48h response SLA)\n- Usage analytics dashboard\n- Priority updates\n- Early access to new features\n\n**TEAM TIER - $199/month**\n- 25,000 agent tasks/month\n- Unlimited users\n- Slack/Discord support (24h response SLA)\n- Advanced security features\n- Team management & role-based access\n- Audit logging\n- Custom integrations support\n\n**ENTERPRISE TIER - Custom pricing**\n- Unlimited tasks\n- SSO/SAML integration\n- SLA guarantees (99.9% uptime)\n- Dedicated support engineer\n- Custom deployment options (on-premise, air-gapped)\n- Training & onboarding\n- Legal & compliance documentation\n\n## Deliverables\n\n1. **`/docs/PRICING.md`** - Full feature matrix comparing all tiers\n2. **Update `README.md`** - Add pricing section with link to detailed pricing\n3. **`/docs/FAQ.md`** - Common pricing questions:\n   - What counts as an \"agent task\"?\n   - How is usage measured?\n   - Can I upgrade/downgrade anytime?\n   - What happens if I exceed my tier limit?\n4. **Landing page template** (if web presence exists) - Pricing section\n\n## Feature Matrix Example\n\n| Feature | Free | Pro | Team | Enterprise |\n|---------|------|-----|---------|------------|\n| Agent tasks/month | 100 | 5,000 | 25,000 | Unlimited |\n| Users | 1 | 5 | Unlimited | Unlimited |\n| Support | Community | Email (48h) | Slack (24h) | Dedicated |\n| Usage analytics | ✓ | ✓ | ✓ | ✓ |\n| Team management | - | - | ✓ | ✓ |\n| Audit logging | - | - | ✓ | ✓ |\n| SSO/SAML | - | - | - | ✓ |\n| Custom deployment | - | - | - | ✓ |\n| SLA | - | - | - | 99.9% |\n\n## Success Criteria\n\n- [ ] Non-technical buyer can understand value proposition in 30 seconds\n- [ ] Clear path from free → paid tier\n- [ ] Pricing competitive with alternatives (Zapier, n8n Cloud, etc.)\n- [ ] Addresses common objections in FAQ\n\n## Notes\n\n- Start pricing high, offer discounts for early adopters\n- Consider annual pricing (2 months free)\n- Enterprise tier is \"contact sales\" - focus on relationship\n- Track conversion metrics: free → pro, pro → team\n\n## Related Issues\n\n- Depends on: Usage tracking system (to enforce limits)\n- Blocks: Go-to-market launch\n- See also: `MVP_LAUNCH_ROADMAP.md` in arkavo-org/app repo",
  "labels": ["enhancement", "monetization", "documentation"]
}' \
  "$API_URL")

ISSUE1_NUM=$(echo "$ISSUE1" | grep -o '"number":[0-9]*' | head -1 | cut -d: -f2)
echo "✓ Created issue #$ISSUE1_NUM"
echo ""

# Issue 2: Usage Tracking
echo "Creating Issue 2: Usage Tracking & Monetization Dashboard..."
ISSUE2=$(curl -s -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  -H "Content-Type: application/json" \
  -d @- "$API_URL" << 'EOF'
{
  "title": "Implement Usage Tracking & Monetization Dashboard",
  "body": "## Priority: CRITICAL - MONETIZATION CORE\n\n**Related to:** MVP Launch Milestone\n**Effort:** 5-7 days\n\n## Objective\nImplement usage tracking system to measure billable agent tasks and enforce tier limits for monetization.\n\n## Requirements\n\n### Data Model\n\n```rust\nstruct UsageRecord {\n    id: Uuid,\n    org_id: String,              // Organization identifier\n    user_id: String,             // User who triggered the task\n    task_type: TaskType,         // Enum: McpCall, A2aMessage, ToolExecution, etc.\n    timestamp: DateTime<Utc>,\n    cost_credits: i64,           // Internal credit system (1 task = 1 credit)\n    tokens_used: Option<u64>,    // LLM tokens consumed (for analytics)\n    metadata: JsonValue,         // Tool used, model, duration, etc.\n    billable: bool,              // Some tasks may be non-billable (health checks)\n}\n\nenum TaskType {\n    McpToolCall,\n    A2aMessage,\n    LlmCompletion,\n    FileOperation,\n    GitOperation,\n    // ... extensible\n}\n```\n\n### Storage\n\n- **Primary:** SQLite for single-instance deployments\n- **Scale path:** PostgreSQL for multi-instance (future)\n- **Retention:** 90 days detailed, 2 years aggregated\n- **Indexes:** (org_id, timestamp), (user_id, timestamp)\n\n### API Endpoints\n\n```rust\n// Query current usage\nGET /api/v1/usage/current?org_id={org_id}&period={month|day}\nResponse: { \"tasks_used\": 1234, \"limit\": 5000, \"period_start\": \"...\", \"period_end\": \"...\" }\n\n// Historical usage\nGET /api/v1/usage/history?org_id={org_id}&start={date}&end={date}\nResponse: [ { \"date\": \"2025-11-01\", \"tasks\": 123, \"cost_estimate\": 0.0 }, ... ]\n\n// Export for billing\nGET /api/v1/usage/export?org_id={org_id}&month={YYYY-MM}&format={csv|json}\nResponse: CSV or JSON download\n\n// Real-time usage (WebSocket)\nWS /api/v1/usage/stream?org_id={org_id}\nUpdates: { \"event\": \"task_completed\", \"tasks_remaining\": 4999, ... }\n```\n\n### Dashboard UI Requirements\n\n1. **Current Usage Widget**\n   - Progress bar showing X / Y tasks used\n   - Projection: \"On track for $X this month\"\n   - Days remaining in billing period\n\n2. **Usage Chart**\n   - Daily tasks over last 30 days\n   - Hover tooltips with breakdown by task type\n\n3. **Alerts**\n   - 75% usage: \"You've used 75% of your monthly tasks\"\n   - 90% usage: \"Approaching limit - consider upgrading\"\n   - 100% usage: \"Limit reached - upgrade to continue\" (with CTA button)\n\n4. **Task Breakdown**\n   - Pie chart: % by task type (MCP calls, A2A messages, etc.)\n   - Top users by consumption\n   - Top tools/integrations by usage\n\n5. **Export Button**\n   - Download CSV for accounting\n   - Date range picker\n\n### Enforcement Logic\n\n```rust\nasync fn check_usage_limit(org_id: &str, task_type: TaskType) -> Result<(), UsageError> {\n    let usage = get_current_usage(org_id).await?;\n    let limit = get_org_tier_limit(org_id).await?;\n    \n    if usage.tasks_used >= limit {\n        // Log the rejection\n        emit_metric(\"usage.limit_exceeded\", org_id);\n        \n        return Err(UsageError::LimitExceeded {\n            used: usage.tasks_used,\n            limit,\n            message: \"Monthly task limit reached. Please upgrade your plan.\",\n            upgrade_url: \"https://arkavo.com/pricing\",\n        });\n    }\n    \n    Ok(())\n}\n```\n\n### Billable Task Definition\n\n**Counts as 1 task:**\n- MCP tool execution\n- A2A message sent\n- LLM completion request\n- File operation (read/write/edit)\n- Git operation (commit, push, etc.)\n\n**Non-billable (0 tasks):**\n- Health checks / ping\n- WebSocket connection maintenance\n- UI state queries\n- Authentication requests\n\n## Implementation Steps\n\n1. **Phase 1: Data Layer (2 days)**\n   - [ ] Create SQLite schema\n   - [ ] Implement UsageRecord model\n   - [ ] Write storage trait (UsageStore)\n   - [ ] Unit tests for storage\n\n2. **Phase 2: Tracking (2 days)**\n   - [ ] Add tracking hooks to task execution paths\n   - [ ] Implement background aggregation job (hourly rollup)\n   - [ ] Add usage check before task execution\n   - [ ] Integration tests for enforcement\n\n3. **Phase 3: API & UI (2-3 days)**\n   - [ ] Implement REST API endpoints\n   - [ ] Build dashboard UI components\n   - [ ] Add WebSocket for real-time updates\n   - [ ] Export functionality (CSV)\n\n4. **Phase 4: Polish (1 day)**\n   - [ ] Add usage alerts/notifications\n   - [ ] Performance optimization (caching)\n   - [ ] Documentation\n   - [ ] End-to-end testing\n\n## Success Criteria\n\n- [ ] Can answer: \"How many tasks did org X use this month?\"\n- [ ] Can enforce tier limits (free tier stops at 100 tasks)\n- [ ] Dashboard loads in <500ms\n- [ ] Real-time updates within 2 seconds of task completion\n- [ ] Export generates correct billing data\n- [ ] No false positives/negatives in limit enforcement\n\n## Security Considerations\n\n- Usage data is sensitive (reveals customer behavior)\n- API endpoints must verify caller owns the org_id\n- Rate limit the export endpoint (prevent abuse)\n- Audit log access to usage data\n\n## Performance Targets\n\n- Track 1000 tasks/sec without backlog\n- Query current usage in <10ms (cached)\n- Dashboard load time <500ms\n- Export 1M records in <30s\n\n## Related Issues\n\n- Depends on: Organization management (#TBD)\n- Blocks: Pricing enforcement, billing system\n- Related: #181 Budget System UI\n- See also: `MVP_LAUNCH_ROADMAP.md`",
  "labels": ["enhancement", "monetization", "backend"]
}
EOF
)

ISSUE2_NUM=$(echo "$ISSUE2" | grep -o '"number":[0-9]*' | head -1 | cut -d: -f2)
echo "✓ Created issue #$ISSUE2_NUM"
echo ""

# Issue 3: Team Management
echo "Creating Issue 3: Team/Organization Management MVP..."
ISSUE3=$(curl -s -X POST \
  -H "Authorization: token $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github+json" \
  -H "Content-Type: application/json" \
  -d @- "$API_URL" << 'EOF'
{
  "title": "Team/Organization Management MVP",
  "body": "## Priority: MEDIUM - REQUIRED FOR TEAM TIER\n\n**Related to:** MVP Launch Milestone\n**Effort:** 4-6 days\n\n## Objective\nImplement organization concept to support Team tier ($199/mo) with multiple users sharing a usage quota.\n\n## Requirements\n\n### Data Model\n\n```rust\nstruct Organization {\n    id: Uuid,\n    name: String,                    // \"Acme Corp Engineering\"\n    slug: String,                    // \"acme-corp-eng\" (URL-safe)\n    created_at: DateTime<Utc>,\n    tier: SubscriptionTier,          // Free, Pro, Team, Enterprise\n    usage_limit: i64,                // Tasks per month based on tier\n    billing_email: String,\n    settings: OrgSettings,\n}\n\nstruct OrgMember {\n    org_id: Uuid,\n    user_id: Uuid,\n    role: MemberRole,                // Admin, Member, Viewer\n    joined_at: DateTime<Utc>,\n    invited_by: Option<Uuid>,\n}\n\nenum MemberRole {\n    Admin,      // Full control: billing, invite/remove users, settings\n    Member,     // Can use agents, view usage\n    Viewer,     // Read-only: view usage, no agent execution\n}\n\nenum SubscriptionTier {\n    Free,       // 100 tasks, 1 user\n    Pro,        // 5000 tasks, 5 users\n    Team,       // 25000 tasks, unlimited users\n    Enterprise, // Unlimited tasks, unlimited users\n}\n\nstruct Invitation {\n    id: Uuid,\n    org_id: Uuid,\n    email: String,\n    role: MemberRole,\n    invited_by: Uuid,\n    created_at: DateTime<Utc>,\n    expires_at: DateTime<Utc>,       // 7 days\n    token: String,                   // Secure random token\n    status: InvitationStatus,\n}\n\nenum InvitationStatus {\n    Pending,\n    Accepted,\n    Expired,\n    Revoked,\n}\n```\n\n### API Endpoints\n\n```rust\n// Organization management\nPOST   /api/v1/orgs                          // Create organization\nGET    /api/v1/orgs/{org_id}                 // Get org details\nPATCH  /api/v1/orgs/{org_id}                 // Update settings\nDELETE /api/v1/orgs/{org_id}                 // Delete org (admin only)\n\n// Member management\nGET    /api/v1/orgs/{org_id}/members         // List members\nDELETE /api/v1/orgs/{org_id}/members/{user_id} // Remove member\nPATCH  /api/v1/orgs/{org_id}/members/{user_id} // Update role\n\n// Invitations\nPOST   /api/v1/orgs/{org_id}/invitations    // Send invitation\nGET    /api/v1/orgs/{org_id}/invitations    // List pending invitations\nDELETE /api/v1/orgs/{org_id}/invitations/{id} // Revoke invitation\nPOST   /api/v1/invitations/{token}/accept   // Accept invitation (public)\n```\n\n### User Flows\n\n**1. Create Organization (upgrade from free)**\n```\nUser (free tier) → \"Upgrade to Team\" button\n→ Fill form: org name, billing email\n→ Payment (Stripe checkout)\n→ Organization created\n→ User becomes org Admin\n→ Redirect to \"Invite team members\" page\n```\n\n**2. Invite Team Member**\n```\nAdmin → Org Settings → Members → \"Invite Member\"\n→ Enter email, select role (Admin/Member/Viewer)\n→ System sends email with invite link\n→ Invitee clicks link → creates account or logs in\n→ Joins organization\n→ Can now use shared quota\n```\n\n**3. Remove Member**\n```\nAdmin → Members list → Click \"Remove\" next to member\n→ Confirmation dialog: \"Remove Alice? Her access will be revoked immediately.\"\n→ Member removed\n→ Their API keys invalidated\n→ Audit log entry created\n```\n\n### UI Components\n\n**1. Organization Settings Page (`/org/settings`)**\n- Organization name (editable by admin)\n- Current tier badge (\"Team Plan\")\n- Billing email (editable by admin)\n- Usage quota (read-only, links to usage dashboard)\n- Danger zone: Delete organization\n\n**2. Members Management (`/org/members`)**\n- Table with columns: Name, Email, Role, Joined, Actions\n- \"Invite Member\" button (admin only)\n- Role dropdown (admin can change roles)\n- \"Remove\" button (admin only, can't remove self if last admin)\n- Shows pending invitations in separate section\n\n**3. Invitation Email Template**\n```\nSubject: You've been invited to join {org_name} on Arkavo Edge\n\nHi,\n\n{inviter_name} has invited you to join {org_name} as a {role} on Arkavo Edge.\n\nArkavo Edge is a secure AI agent orchestration platform that lets teams automate \nworkflows while maintaining data privacy.\n\nAccept invitation: {invite_link}\n\nThis invitation expires in 7 days.\n\nQuestions? Reply to this email or visit https://docs.arkavo.com\n\n---\nThe Arkavo Team\n```\n\n### Permission Checks\n\n```rust\n// Example: Before inviting a member\nasync fn check_permission(user_id: Uuid, org_id: Uuid, required: Permission) -> Result<(), AuthError> {\n    let member = get_org_member(org_id, user_id).await?;\n    \n    match (member.role, required) {\n        (MemberRole::Admin, _) => Ok(()), // Admins can do anything\n        (MemberRole::Member, Permission::ExecuteAgent) => Ok(()),\n        (MemberRole::Member, Permission::ViewUsage) => Ok(()),\n        (MemberRole::Viewer, Permission::ViewUsage) => Ok(()),\n        _ => Err(AuthError::Forbidden),\n    }\n}\n```\n\n### Business Rules\n\n1. **Free tier:** No organizations (single user only)\n2. **Pro tier:** Can create 1 org with up to 5 members\n3. **Team tier:** Can create 1 org with unlimited members\n4. **Enterprise tier:** Can create multiple orgs\n\n5. **At least one admin:** Can't remove last admin from org\n6. **Invitation expiry:** 7 days, then auto-revoked\n7. **Email uniqueness:** One user can be member of multiple orgs\n\n### Migration Path\n\n**Existing single users → Organizations:**\n```sql\n-- When user upgrades to Team tier\n-- 1. Create organization with user's name\nINSERT INTO organizations (id, name, slug, tier) \nVALUES (gen_uuid(), '{user.name} Organization', '{user.name}-org', 'Team');\n\n-- 2. Add user as admin\nINSERT INTO org_members (org_id, user_id, role) \nVALUES ({new_org_id}, {user_id}, 'Admin');\n\n-- 3. Migrate their usage to org\nUPDATE usage_records \nSET org_id = {new_org_id} \nWHERE user_id = {user_id};\n```\n\n## Implementation Steps\n\n**Phase 1: Data Layer (1-2 days)**\n- [ ] Database schema for orgs, members, invitations\n- [ ] Storage trait implementations\n- [ ] Unit tests for CRUD operations\n\n**Phase 2: API (2 days)**\n- [ ] REST endpoints for org management\n- [ ] Permission middleware\n- [ ] Invitation flow (send email, accept, revoke)\n- [ ] Integration tests\n\n**Phase 3: UI (2-3 days)**\n- [ ] Organization settings page\n- [ ] Members management page\n- [ ] Invitation acceptance flow\n- [ ] Update navigation (add \"Org\" menu)\n\n**Phase 4: Migration & Polish (1 day)**\n- [ ] Migration script for existing users\n- [ ] Email templates\n- [ ] Documentation\n- [ ] End-to-end testing\n\n## Success Criteria\n\n- [ ] Admin can create organization and invite 10 members in <5 minutes\n- [ ] Members share usage quota correctly\n- [ ] Permission checks prevent unauthorized actions\n- [ ] Invitation emails deliver within 1 minute\n- [ ] Can't orphan an organization (always has ≥1 admin)\n- [ ] All actions audit logged\n\n## Out of Scope (Defer to Post-MVP)\n\n- Fine-grained permissions (custom roles)\n- Team management across multiple orgs (Enterprise feature)\n- SCIM/directory sync\n- Member usage quotas (individual limits within org)\n- Advanced invitation workflows (approval chains)\n\n## Security Considerations\n\n- Invitation tokens must be cryptographically secure (256-bit)\n- Rate limit invitation sends (max 10/hour per org to prevent spam)\n- Verify email ownership before adding to org\n- Audit log all membership changes\n- Prevent privilege escalation (member can't make themselves admin)\n\n## Related Issues\n\n- Depends on: User authentication system\n- Blocks: Team tier monetization\n- Related: Usage tracking (#TBD), Pricing (#TBD)\n- See also: `MVP_LAUNCH_ROADMAP.md`",
  "labels": ["enhancement", "monetization", "backend", "frontend"]
}
EOF
)

ISSUE3_NUM=$(echo "$ISSUE3" | grep -o '"number":[0-9]*' | head -1 | cut -d: -f2)
echo "✓ Created issue #$ISSUE3_NUM"
echo ""

echo "================================================"
echo "✓ Successfully created 3 MVP launch issues!"
echo ""
echo "Issue #$ISSUE1_NUM: Pricing Page & Commercial Tier Structure"
echo "Issue #$ISSUE2_NUM: Usage Tracking & Monetization Dashboard"
echo "Issue #$ISSUE3_NUM: Team/Organization Management MVP"
echo ""
echo "View issues at: https://github.com/$REPO/issues"
echo "================================================"
